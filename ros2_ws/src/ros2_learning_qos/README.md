# ğŸ“¡ ROS 2 QoS (Quality of Service) æ·±åº¦è§£æï¼šç«æ˜Ÿæ¢æµ‹è½¦é€šä¿¡å®æˆ˜

æœ¬é¡¹ç›®é€šè¿‡æ¨¡æ‹Ÿ **ç«æ˜Ÿæ¢æµ‹è½¦ (Mars Rover)** ä¸ **åœ°çƒæ§åˆ¶ä¸­å¿ƒ (Mission Control)** ä¹‹é—´çš„é€šä¿¡ï¼Œæ¼”ç¤º ROS 2 åŸºäº DDS çš„ QoS æœºåˆ¶ã€‚

ROS 2 åº•å±‚ä½¿ç”¨ DDS (Data Distribution Service)ï¼Œé»˜è®¤åŸºäº **UDP** åè®®ã€‚é€šè¿‡é…ç½®ä¸åŒçš„ QoS ç­–ç•¥ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°ç±»ä¼¼ TCP çš„å¯é ä¼ è¾“ï¼Œæˆ–è€…ç±»ä¼¼ UDP çš„å®æ—¶ä¼ è¾“ï¼Œç”šè‡³æ›´é«˜çº§çš„å†å²æ•°æ®ä¿ç•™å’Œå­˜æ´»æ£€æµ‹ã€‚

## ğŸª ä¸šåŠ¡åœºæ™¯ (Business Scenario)

åœ¨ç«æ˜Ÿæ¢æµ‹ä»»åŠ¡ä¸­ï¼Œé€šä¿¡å¸¦å®½æä½ä¸”ä¸ç¨³å®šï¼Œä¸åŒæ•°æ®çš„ä¼˜å…ˆçº§å®Œå…¨ä¸åŒï¼š

| æ•°æ®ç±»å‹ | ä¸šåŠ¡éœ€æ±‚ | æ¨è QoS ç­–ç•¥ | å¯¹åº” DDS è¡Œä¸º |
| :--- | :--- | :--- | :--- |
| **å®æ—¶è§†é¢‘æµ** | é«˜é¢‘æ•°æ®ï¼Œå…è®¸å¶å°”ä¸¢å¸§ï¼Œä½†å¿…é¡»ä¿è¯ä½å»¶è¿Ÿã€‚è¿‡æ—¶çš„å¸§æ²¡æœ‰ä»·å€¼ã€‚ | **Best Effort** + Volatile | ç±»ä¼¼ UDPï¼Œå‘åå³å¿˜ã€‚ä¸é‡ä¼ ï¼Œä¸ç¡®è®¤ã€‚ |
| **ç´§æ€¥æŒ‡ä»¤ç¡®è®¤** | å¿…é¡»ç¡®ä¿æŒ‡ä»¤ï¼ˆå¦‚æ€¥åœï¼‰å·²é€è¾¾ã€‚å¦‚æœç½‘ç»œä¸¢åŒ…ï¼Œå¿…é¡»é‡ä¼ ã€‚ | **Reliable** + Volatile | ç±»ä¼¼ TCPï¼Œæœ‰ ACK æœºåˆ¶å’Œé‡ä¼ é˜Ÿåˆ—ã€‚ |
| **é™æ€åœ°å›¾æ•°æ®** | åœ°å›¾å¾ˆå°‘æ›´æ–°ã€‚**ååŠ å…¥**çš„æ§åˆ¶å°ï¼ˆLate Joinerï¼‰å¿…é¡»èƒ½æ”¶åˆ°æœ€è¿‘çš„ä¸€ä»½åœ°å›¾ã€‚ | **Reliable** + **Transient Local** | å‘å¸ƒè€…ä¼šä¿ç•™æœ€å N æ¡æ•°æ®ï¼Œæ–°è®¢é˜…è€…è¿æ¥æ—¶è‡ªåŠ¨è¡¥å‘ï¼ˆç±»ä¼¼ ROS 1 Latchedï¼‰ã€‚ |
| **ç³»ç»Ÿå¿ƒè·³** | å®‰å…¨ç›‘æ§ã€‚å¦‚æœ N æ¯«ç§’å†…æ²¡æ”¶åˆ°å¿ƒè·³ï¼Œè§†ä¸ºç³»ç»Ÿå¤±è”ï¼Œè§¦å‘æŠ¥è­¦ã€‚ | **Deadline** (600ms) | å¦‚æœå‘å¸ƒ/æ¥æ”¶é—´éš”è¶…è¿‡è®¾å®šå€¼ï¼Œè§¦å‘äº‹ä»¶å›è°ƒã€‚ |

## ğŸ› ï¸ ä»£ç ç»“æ„ (ç»„ä»¶åŒ–æ¶æ„)

æœ¬é¡¹ç›®é‡‡ç”¨äº† ROS 2 æ¨èçš„ **Composition (ç»„ä»¶åŒ–)** æ¶æ„ï¼Œå®ç°äº†èŠ‚ç‚¹çš„è§£è€¦å’Œé›¶æ‹·è´é€šä¿¡ï¼š

- **`rover_node.hpp / .cpp`**: æ¨¡æ‹Ÿç«æ˜Ÿè½¦ï¼Œå‘å¸ƒä¸Šè¿° 4 ç§æ•°æ®ã€‚æ³¨å†Œä¸ºå¯åŠ¨æ€åŠ è½½çš„æ’ä»¶ã€‚
- **`mission_control_node.hpp / .cpp`**: æ¨¡æ‹Ÿæ§åˆ¶å°ï¼Œè®¢é˜…æ•°æ®å¹¶ç›‘æ§ QoS äº‹ä»¶ï¼ˆå¦‚ Deadline Missedï¼‰ã€‚æ³¨å†Œä¸ºæ’ä»¶ã€‚
- **`qos_demo.launch.py`**: ä½¿ç”¨ `ComposableNodeContainer` å°†ä¸Šè¿°ä¸¤ä¸ªèŠ‚ç‚¹åŠ è½½åˆ°**åŒä¸€ä¸ªè¿›ç¨‹**ä¸­è¿è¡Œã€‚

é€šè¿‡ç»„ä»¶åŒ–ï¼Œæˆ‘ä»¬ä¸ä»…å±•ç¤ºäº†å„ç§ QoS ç­–ç•¥ï¼Œè¿˜å±•ç¤ºäº† ROS 2 å¦‚ä½•åœ¨åŒä¸€è¿›ç¨‹å†…å®ç°é«˜æ€§èƒ½çš„é›¶æ‹·è´é€šä¿¡ã€‚

## ğŸš€ ç¼–è¯‘ä¸è¿è¡Œ

1. **ç¼–è¯‘**:
   ```bash
   cd ~/Ros2Learning/ros2_ws
   colcon build --packages-select ros2_learning_qos --parallel-workers 2
   source install/setup.bash
   ```

2. **è¿è¡Œæ¼”ç¤º (æ¨èï¼šåŒè¿›ç¨‹ç»„ä»¶æ¨¡å¼)**:
   ```bash
   ros2 launch ros2_learning_qos qos_demo.launch.py
   ```
   > å®¹å™¨ `component_container` ä¼šå°†ç«æ˜Ÿè½¦å’Œæ§åˆ¶å°ä¸¤ä¸ªæ’ä»¶åŠ è½½åˆ°åŒä¸€ä¸ªè¿›ç¨‹ä¸­è¿è¡Œã€‚

3. **è¿è¡Œæ¼”ç¤º (å¤‡é€‰ï¼šç‹¬ç«‹è¿›ç¨‹æ¨¡å¼)**:
   å¦‚æœä½ æƒ³è·¨è¿›ç¨‹æµ‹è¯•çœŸå®çš„ DDS ç½‘ç»œè¡Œä¸ºï¼Œä¹Ÿå¯ä»¥èµ·ä¸¤ä¸ªç»ˆç«¯åˆ†åˆ«è¿è¡Œï¼ˆå‘åå…¼å®¹ï¼‰ï¼š
   ```bash
   ros2 run ros2_learning_qos qos_producer
   ros2 run ros2_learning_qos qos_consumer
   ```

## ğŸ§ª å®éªŒç°è±¡é¢„æœŸ

1. **è§†é¢‘æµ**: æ§åˆ¶å°ä¼šæ”¶åˆ°å¤§é‡è§†é¢‘æ•°æ®ï¼Œæ—¥å¿—æ˜¾ç¤º `[Rover] å‘é€è§†é¢‘æµ (Best Effort)`ã€‚å¦‚æœç½‘ç»œä¸å¥½ï¼Œä¸­é—´ä¼šä¸¢åŒ…ä½†ä¸ä¼šé˜»å¡ã€‚
2. **åœ°å›¾æ•°æ®**: å³ä½¿ `MissionControl` å¯åŠ¨è¾ƒæ…¢ï¼Œæˆ–è€…ä¸­é€”é‡å¯ï¼Œå®ƒä¸€å¯åŠ¨å°±èƒ½æ”¶åˆ° `>>> [Control] åŒæ­¥åˆ°åœ°å›¾æ•°æ® <<<`ï¼Œå› ä¸º Publisher è®¾ç½®äº† `Transient Local`ã€‚
3. **å¿ƒè·³ç›‘æ§**: 
   - æ­£å¸¸æƒ…å†µä¸‹å¿ƒè·³å¹³ç¨³ã€‚
   - ä»£ç ä¸­æ¨¡æ‹Ÿäº† **æ¯ 10 ç§’ä¸€æ¬¡çš„ä¸¢åŒ…**ï¼ˆè·³è¿‡ 3 è½®å¿ƒè·³å‘å¸ƒï¼‰ã€‚
   - æ­¤æ—¶ä½ ä¼šçœ‹åˆ°æ§åˆ¶å°æŠ¥é”™ï¼š`!!! [ALARM] å¿ƒè·³ä¸¢å¤±ï¼æˆªæ­¢æœŸæœªæ”¶åˆ°æ•°æ® !!!`ã€‚è¿™å±•ç¤ºäº† Deadline QoS çš„ä½œç”¨ï¼Œä¸”ä¸ä¼šåƒ `sleep_for` é‚£æ ·é˜»å¡æ•´ä¸ªç³»ç»Ÿã€‚
4. **ä¸å…¼å®¹æµ‹è¯•**: ä»£ç ä¸­å°è¯•ç”¨ `Reliable` è®¢é˜… `Best Effort` çš„è§†é¢‘æµï¼Œç»“æœæ˜¯**æ”¶ä¸åˆ°ä»»ä½•æ•°æ®**ã€‚è¿™æ˜¯å› ä¸º QoS å…¼å®¹æ€§è§„åˆ™ï¼ˆRequest > Offerï¼‰ã€‚

## ğŸ“š å…³é”®ä»£ç ç‰‡æ®µ (C++)

```cpp
// 1. è§†é¢‘æµï¼šBest Effort (åƒ UDP)
auto camera_qos = rclcpp::SensorDataQoS(); 

// 2. åœ°å›¾ï¼šTransient Local (åƒ Latched)
auto map_qos = rclcpp::QoS(rclcpp::KeepLast(1)).transient_local().reliable();

// 3. å¿ƒè·³ï¼šDeadline (çœ‹é—¨ç‹—)
auto heartbeat_qos = rclcpp::QoS(rclcpp::KeepLast(10)).deadline(600ms);
```

é€šè¿‡è¿™ä¸ª Demoï¼Œä½ å¯ä»¥ç›´è§‚åœ°ç†è§£ ROS 2 å¦‚ä½•åˆ©ç”¨ DDS çš„å¼ºå¤§ç‰¹æ€§æ¥åº”å¯¹å¤æ‚çš„ç½‘ç»œç¯å¢ƒã€‚
