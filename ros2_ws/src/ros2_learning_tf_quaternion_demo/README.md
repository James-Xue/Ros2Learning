# ROS 2 å››å…ƒæ•°å’Œ TF å˜æ¢æ¼”ç¤º

æœ¬åŒ…é€šè¿‡äº¤äº’å¼å¯è§†åŒ–å’Œè¯¦ç»†æ³¨é‡Šçš„ä»£ç ï¼Œå¸®åŠ©æ‚¨å½»åº•ç†è§£å››å…ƒæ•°ï¼ˆQuaternionï¼‰å’Œåæ ‡å˜æ¢ï¼ˆTFï¼‰çš„æ¦‚å¿µã€‚

## ğŸ¯ å­¦ä¹ ç›®æ ‡

å®Œæˆæœ¬æ¼”ç¤ºåï¼Œæ‚¨å°†æŒæ¡ï¼š
- âœ… å››å…ƒæ•°çš„åŸºæœ¬æ¦‚å¿µå’Œæ•°å­¦åŸç†
- âœ… å››å…ƒæ•°ä¸æ¬§æ‹‰è§’çš„è½¬æ¢
- âœ… å››å…ƒæ•°çš„è¿ç®—ï¼ˆä¹˜æ³•ã€æ’å€¼ï¼‰
- âœ… ROS 2 TF ç³»ç»Ÿçš„ä½¿ç”¨
- âœ… å¤šå±‚çº§åæ ‡ç³»çš„å»ºç«‹å’ŒæŸ¥è¯¢
- âœ… ç‚¹å’Œå§¿æ€çš„åæ ‡è½¬æ¢

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¼–è¯‘åŒ…

```bash
cd ~/Ros2Learning/ros2_ws
colcon build --packages-select ros2_learning_tf_quaternion_demo
source install/setup.bash
```

### 2. è¿è¡Œæ¼”ç¤º

```bash
ros2 launch ros2_learning_tf_quaternion_demo demo.launch.py
```

è¿™ä¸ªå‘½ä»¤ä¼šå¯åŠ¨ï¼š
- ğŸ¨ **å››å…ƒæ•°å¯è§†åŒ–èŠ‚ç‚¹** - å±•ç¤º 6 ç§å››å…ƒæ•°æ¦‚å¿µ
- ğŸ“¡ **TF å¹¿æ’­å™¨** - åˆ›å»ºåŠ¨æ€åæ ‡ç³»
- ğŸ“¥ **TF ç›‘å¬å™¨** - æŸ¥è¯¢å’Œè½¬æ¢åæ ‡
- ğŸ–¥ï¸ **RViz** - 3D å¯è§†åŒ–

### 3. è§‚å¯Ÿå’Œå­¦ä¹ 

**åœ¨ RViz ä¸­**ï¼š
- è§‚å¯Ÿä¸åŒé¢œè‰²çš„åæ ‡è½´ï¼ˆX=çº¢ï¼ŒY=ç»¿ï¼ŒZ=è“ï¼‰
- çœ‹æ—‹è½¬çš„åæ ‡ç³»å¦‚ä½•å˜åŒ–
- ç†è§£"æ— æ—‹è½¬"vs"90åº¦æ—‹è½¬"çš„åŒºåˆ«

**åœ¨ç»ˆç«¯ä¸­**ï¼š
- é˜…è¯»èŠ‚ç‚¹è¾“å‡ºçš„è¯¦ç»†è§£é‡Š
- çœ‹å››å…ƒæ•°çš„æ•°å€¼å˜åŒ–
- ç†è§£æ¯ä¸ªæ¼”ç¤ºæ­¥éª¤çš„å«ä¹‰

## ğŸ“š æ¼”ç¤ºå†…å®¹

### æ¼”ç¤º 1: å››å…ƒæ•°åŸºç¡€ï¼ˆå…± 6 ä¸ªæ¦‚å¿µï¼‰

å››å…ƒæ•°æ¼”ç¤ºèŠ‚æ¯ç§’åˆ‡æ¢ï¼Œå±•ç¤ºï¼š

1. **å•ä½å››å…ƒæ•°** (x=0, y=0, z=0, w=1)
   - è¡¨ç¤ºæ— æ—‹è½¬
   - åæ ‡è½´ä¿æŒåŸå§‹æ–¹å‘

2. **ç»• Z è½´æ—‹è½¬ 90Â°**
   - z=0.707, w=0.707
   - X è½´æŒ‡å‘åŸæ¥çš„ Y è½´æ–¹å‘

3. **ç»• X è½´æ—‹è½¬ 90Â°**
   - x=0.707, w=0.707
   - Y è½´æŒ‡å‘åŸæ¥çš„ Z è½´æ–¹å‘

4. **ç»• Y è½´æ—‹è½¬ 90Â°**
   - y=0.707, w=0.707
   - Z è½´æŒ‡å‘åŸæ¥çš„ X è½´æ–¹å‘

5. **æ¬§æ‹‰è§’è½¬å››å…ƒæ•°**
   - roll=30Â°, pitch=45Â°, yaw=60Â°
   - å±•ç¤ºå¤åˆæ—‹è½¬

6. **å››å…ƒæ•°ä¹˜æ³•**
   - ç»„åˆä¸¤æ¬¡æ—‹è½¬
   - q_combined = q2 * q1

### æ¼”ç¤º 2: TF åæ ‡ç³»å±‚çº§

```
world (é™æ€)
  â””â”€ robot_base
      â”œâ”€ rotating_platform (ç»•Zè½´æ—‹è½¬)
      â”‚   â””â”€ sensor_frame (å›ºå®šåç§»ï¼Œå€¾æ–œ30Â°)
      â””â”€ target_object (åœ†å½¢è½¨é“è¿åŠ¨)
```

### æ¼”ç¤º 3: TF æŸ¥è¯¢ç¤ºä¾‹

TF ç›‘å¬å™¨æ¯ç§’è¾“å‡ºï¼š
- ä¼ æ„Ÿå™¨åœ¨ä¸–ç•Œåæ ‡ç³»ä¸­çš„ä½å§¿
- ç‚¹çš„åæ ‡è½¬æ¢ï¼ˆä¼ æ„Ÿå™¨â†’ä¸–ç•Œï¼‰
- ç›®æ ‡ç›¸å¯¹äºä¼ æ„Ÿå™¨çš„è·ç¦»

## ğŸ“– æ ¸å¿ƒæ¦‚å¿µè§£é‡Š

### å››å…ƒæ•°æ˜¯ä»€ä¹ˆï¼Ÿ

å››å…ƒæ•°æ˜¯è¡¨ç¤º 3D æ—‹è½¬çš„ä¸€ç§æ–¹æ³•ï¼Œç”± 4 ä¸ªæ•°ç»„æˆï¼š

```
q = (x, y, z, w)
```

**æ•°å­¦å«ä¹‰**ï¼šç»•æŸä¸ªè½´æ—‹è½¬ä¸€å®šè§’åº¦
```
x = axis_x * sin(angle/2)
y = axis_y * sin(angle/2)
z = axis_z * sin(angle/2)
w = cos(angle/2)
```

**çº¦æŸæ¡ä»¶**ï¼šå¿…é¡»æ˜¯å•ä½å››elementæ•°
```
xÂ² + yÂ² + zÂ² + wÂ² = 1
```

### ä¸ºä»€ä¹ˆä½¿ç”¨å››å…ƒæ•°ï¼Ÿ

| å¯¹æ¯” | æ¬§æ‹‰è§’ | å››å…ƒæ•° |
|------|--------|--------|
| ç›´è§‚æ€§ | âœ… å®¹æ˜“ç†è§£ | âŒ ä¸ç›´è§‚ |
| ä¸‡å‘é” | âŒ ä¼šå‡ºç° | âœ… æ— æ­¤é—®é¢˜ |
| æ’å€¼ | âŒ ä¸å¹³æ»‘ | âœ… å¹³æ»‘ |
| å†…å­˜ | 3ä¸ªæ•° | 4ä¸ªæ•° |
| è®¡ç®— | è¾ƒæ…¢ | è¾ƒå¿« |

**ROS/MoveIt é€‰æ‹©å››å…ƒæ•°çš„åŸå› **ï¼šé¿å…ä¸‡å‘é”ï¼

### TF æ˜¯ä»€ä¹ˆï¼Ÿ

TF (Transform) æ˜¯ ROS ä¸­çš„åæ ‡å˜æ¢ç³»ç»Ÿï¼Œç”¨äºï¼š
- ğŸ“ ç®¡ç†å¤šä¸ªåæ ‡ç³»
- ğŸ”„ è‡ªåŠ¨è®¡ç®—åæ ‡ç³»ä¹‹é—´çš„å…³ç³»
- ğŸ¯ è½¬æ¢ç‚¹/å§¿æ€åˆ°ä¸åŒåæ ‡ç³»

## ğŸ§ª å®è·µç»ƒä¹ 

### ç»ƒä¹  1ï¼šä¿®æ”¹æ—‹è½¬è§’åº¦

ç¼–è¾‘ `src/quaternion_demo.cpp`ï¼Œå°è¯•ä¸åŒçš„æ—‹è½¬è§’åº¦ï¼š

```cpp
// ç»• Z è½´æ—‹è½¬ 45Â° è€Œä¸æ˜¯ 90Â°
double angle = M_PI / 4;  // 45åº¦
```

é‡æ–°ç¼–è¯‘å¹¶è¿è¡Œï¼Œè§‚å¯Ÿå˜åŒ–ï¼

### ç»ƒä¹  2ï¼šæ·»åŠ æ–°çš„åæ ‡ç³»

ç¼–è¾‘ `src/tf_broadcaster_demo.cpp`ï¼Œæ·»åŠ ä¸€ä¸ªæ–°çš„å­åæ ‡ç³»ï¼š

```cpp
// æ·»åŠ ä¸€ä¸ªç›¸æœºåæ ‡ç³»
geometry_msgs::msg::TransformStamped camera_tf;
camera_tf.header.stamp = now;
camera_tf.header.frame_id = "sensor_frame";
camera_tf.child_frame_id = "camera";
// ... è®¾ç½®ä½ç½®å’Œæ–¹å‘
tf_broadcaster_->sendTransform(camera_tf);
```

### ç»ƒä¹  3ï¼šæŸ¥è¯¢è‡ªå®šä¹‰å˜æ¢

ç¼–è¾‘ `src/tf_listener_demo.cpp`ï¼ŒæŸ¥è¯¢æ‚¨æ–°æ·»åŠ çš„åæ ‡ç³»ã€‚

## ğŸ”§ å¸¸ç”¨å·¥å…·å‘½ä»¤

```bash
# æŸ¥çœ‹ TF æ ‘
ros2 run tf2_tools view_frames

# å®æ—¶æŸ¥çœ‹ç‰¹å®šå˜æ¢
ros2 run tf2_ros tf2_echo world sensor_frame

# æŸ¥çœ‹æ‰€æœ‰ TF
ros2 topic echo /tf

# æŸ¥çœ‹ TF ç»Ÿè®¡
rqt_tf_tree
```

## ğŸ“ å¸¸ç”¨ä»£ç æ¨¡æ¿

### åˆ›å»ºå››å…ƒæ•°

```cpp
#include <tf2/LinearMath/Quaternion.h>

tf2::Quaternion q;

// æ–¹æ³•1ï¼šä»æ¬§æ‹‰è§’
q.setRPY(roll, pitch, yaw);

// æ–¹æ³•2ï¼šä»è½´è§’
q.setRotation(tf2::Vector3(0, 0, 1), angle);  // ç»•Zè½´

// æ–¹æ³•3ï¼šç›´æ¥è®¾ç½®
q = tf2::Quaternion(x, y, z, w);
```

### å››å…ƒæ•°è½¬æ¬§æ‹‰è§’

```cpp
#include <tf2/LinearMath/Matrix3x3.h>

tf2::Quaternion q = ...;
double roll, pitch, yaw;
tf2::Matrix3x3(q).getRPY(roll, pitch, yaw);
```

### å¹¿æ’­ TF

```cpp
#include <tf2_ros/transform_broadcaster.h>

auto tf_broadcaster = std::make_shared<tf2_ros::TransformBroadcaster>(node);

geometry_msgs::msg::TransformStamped t;
t.header.stamp = node->now();
t.header.frame_id = "parent";
t.child_frame_id = "child";
// ... è®¾ç½® translation å’Œ rotation
tf_broadcaster->sendTransform(t);
```

### æŸ¥è¯¢ TF

```cpp
#include <tf2_ros/buffer.h>
#include <tf2_ros/transform_listener.h>

auto tf_buffer = std::make_shared<tf2_ros::Buffer>(node->get_clock());
auto tf_listener = std::make_shared<tf2_ros::TransformListener>(*tf_buffer);

try {
    auto transform = tf_buffer->lookupTransform(
        "target_frame",
        "source_frame",
        tf2::TimePointZero
    );
    // ä½¿ç”¨ transform
} catch (tf2::TransformException& ex) {
    RCLCPP_WARN(node->get_logger(), "%s", ex.what());
}
```

## ğŸ“ è¿›é˜¶èµ„æº

- [TF2 å®˜æ–¹æ•™ç¨‹](https://docs.ros.org/en/jazzy/Tutorials/Intermediate/Tf2/Tf2-Main.html)
- [å››å…ƒæ•°å¯è§†åŒ–å·¥å…·](https://quaternions.online/)
- [MoveIt æ•™ç¨‹](https://moveit.picknik.ai/jazzy/)

## ğŸ’¡ è°ƒè¯•æŠ€å·§

1. **RViz ä¸­çœ‹ä¸åˆ°åæ ‡è½´ï¼Ÿ**
   - æ£€æŸ¥ Fixed Frame æ˜¯å¦è®¾ç½®ä¸º "world"
   - æ·»åŠ  TF display æ’ä»¶

2. **å››å…ƒæ•°å€¼çœ‹èµ·æ¥å¾ˆå¥‡æ€ªï¼Ÿ**
   - è®°ä½ï¼šè§’åº¦éœ€è¦é™¤ä»¥ 2ï¼
   - angle/2 = 90Â°/2 = 45Â° â†’ sin(45Â°) = 0.707

3. **TF æŸ¥è¯¢å¤±è´¥ï¼Ÿ**
   - ç¡®ä¿çˆ¶å­åæ ‡ç³»éƒ½è¢«å¹¿æ’­
   - æ£€æŸ¥æ—¶é—´æˆ³æ˜¯å¦æ­£ç¡®

## ğŸ“ æ€»ç»“

**å››å…ƒæ•°**ï¼š
- ç”¨ 4 ä¸ªæ•°è¡¨ç¤º 3D æ—‹è½¬
- w=1 è¡¨ç¤ºæ— æ—‹è½¬
- é¿å…äº†ä¸‡å‘é”é—®é¢˜

**TF**ï¼š
- ç®¡ç†å¤šä¸ªåæ ‡ç³»
- è‡ªåŠ¨è®¡ç®—å˜æ¢
- æ”¯æŒåŠ¨æ€å’Œé™æ€å˜æ¢

ç°åœ¨å¼€å§‹è¿è¡Œæ¼”ç¤ºï¼Œäº²è‡ªä½“éªŒå§ï¼ğŸš€
